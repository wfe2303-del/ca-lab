<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ìˆ˜ê°•ìƒ ì‹œíŠ¸ ìë™ ì—…ë°ì´íŠ¸ Â· ClassAround</title>
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <!-- Google API (Sheets) -->
  <script src="https://apis.google.com/js/api.js" async defer></script>
  <style>
    body{
      margin:0;
      background:#f1f5f9;
      color:#0f172a;
      font:13px/1.5 system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial;
    }
    header{
      background:#ffffff;
      border-bottom:1px solid #e2e8f0;
    }
    .toast{
      position:fixed;
      right:14px;
      bottom:14px;
      padding:8px 12px;
      border-radius:999px;
      background:#0f172a;
      color:#fff;
      opacity:0;
      box-shadow:0 6px 20px rgba(15,23,42,.35);
      z-index:1000;
      font-size:12px;
      transform:translateY(8px);
      pointer-events:none;
      transition:.22s;
    }
    .toast.show{
      opacity:.97;
      transform:translateY(0);
      pointer-events:auto;
    }
    .scroll-xy{overflow:auto}
    table.preview{border-collapse:collapse;width:100%}
    table.preview td,table.preview th{
      border:1px solid #e2e8f0;
      padding:4px 6px;
      white-space:nowrap;
      font-size:11px;
    }
    table.preview th{
      background:#eff6ff;
      position:sticky;
      top:0;
      z-index:1;
      color:#1e293b;
    }
    .invalid{background:#fef2f2;color:#b91c1c}
    .fname{display:none;}
  </style>
</head>
<body class="min-h-screen">
  <header>
    <div class="max-w-5xl mx-auto px-4 py-2.5 flex items-center justify-between gap-3">
      <div class="flex items-center gap-3">
        <svg class="w-20 h-11" viewBox="0 0 90 50" role="img" aria-label="ClassAround">
          <rect width="90" height="50" rx="10" fill="white"/>
          <circle cx="66" cy="10" r="8" fill="#6b8bd6"/>
          <circle cx="80" cy="18" r="5" fill="#ef4444"/>
          <text x="8" y="24"
                style="font-family:'Nunito','Arial Rounded MT','SF Pro Rounded','Quicksand','Pretendard','Noto Sans KR',sans-serif;
                       font-weight:900; letter-spacing:-0.2px; fill:#0f172a; font-size:18px;
                       paint-order:stroke fill; stroke:#0f172a; stroke-width:.9px;">
            Class
          </text>
          <text x="8" y="42"
                style="font-family:'Nunito','Arial Rounded MT','SF Pro Rounded','Quicksand','Pretendard','Noto Sans KR',sans-serif;
                       font-weight:900; letter-spacing:-0.2px; fill:#0f172a; font-size:18px;
                       paint-order:stroke fill; stroke:#0f172a; stroke-width:.9px;">
            Around
          </text>
        </svg>
        <div class="flex flex-col">
          <span class="text-xs md:text-sm font-bold text-slate-900">ìˆ˜ê°•ìƒ ì‹œíŠ¸ ì—…ë°ì´íŠ¸</span>
        </div>
      </div>
      <div class="flex items-center gap-2 md:gap-3 text-[11px]">
        <div class="flex items-center gap-1">
          <span id="authStateDot" class="inline-block w-2 h-2 rounded-full bg-slate-300"></span>
          <span id="authState" class="text-slate-500">Google ì‹œíŠ¸ ì—°ë™ ì¤€ë¹„ ì¤‘</span>
        </div>
        <button id="btnAuthRefresh"
                type="button"
                class="px-2.5 py-1 rounded-full border border-sky-500 bg-white text-sky-600 hover:bg-sky-50 text-[11px]">
          Google ì¸ì¦
        </button>
        <a href="index.html"
           class="px-2.5 py-1 rounded-full border border-slate-200 bg-white text-slate-700 hover:bg-slate-50 text-[11px]">
          ë©”ì¸ìœ¼ë¡œ
        </a>
      </div>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-4 py-4 space-y-3">
    <section class="grid md:grid-cols-2 gap-3">
      <div class="rounded-xl border border-slate-200 bg-white px-3 py-3 space-y-3 shadow-sm">
        <div class="space-y-1">
          <div class="flex items-center justify-between text-[12px]">
            <div class="flex items-center gap-1.5">
              <span>ğŸ’³</span>
              <span class="font-semibold text-slate-900">ì¹´ë“œê²°ì œ</span>
            </div>
          </div>
          <input id="csvCard" type="file" accept="text/csv,.csv"
                 class="block w-full text-[12px] cursor-pointer bg-white border border-slate-300 rounded-lg px-2.5 py-1.5 file:mr-2 file:px-2 file:py-1 file:rounded-md file:border-0 file:bg-slate-100 file:text-[11px] file:text-slate-700 file:cursor-pointer" />
          <div id="nameCard" class="fname"></div>
          <label class="inline-flex items-center gap-1.5 text-[11px] mt-0.5 text-slate-600">
            <input type="checkbox" id="headCard" class="accent-blue-600" checked />
            í—¤ë”
          </label>
        </div>

        <div class="h-px bg-slate-100 my-1"></div>

        <div class="space-y-1">
          <div class="flex items-center justify-between text-[12px]">
            <div class="flex items-center gap-1.5">
              <span>ğŸ¦</span>
              <span class="font-semibold text-slate-900">ê³„ì¢Œì´ì²´</span>
            </div>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 mt-1">
            <div class="space-y-1">
              <label class="text-[11px] text-slate-600">ì…ì¶œê¸ˆ ì›ì¥</label>
              <input id="csvTicket" type="file" accept="text/csv,.csv"
                     class="block w-full text-[12px] cursor-pointer bg-white border border-slate-300 rounded-lg px-2.5 py-1.5 file:mr-2 file:px-2 file:py-1 file:rounded-md file:border-0 file:bg-slate-100 file:text-[11px] file:text-slate-700 file:cursor-pointer" />
              <div id="nameTicket" class="fname"></div>
              <label class="inline-flex items-center gap-1.5 text-[11px] mt-0.5 text-slate-600">
                <input type="checkbox" id="headTicket" class="accent-blue-600" checked />
                í—¤ë”
              </label>
            </div>

            <div class="space-y-1">
              <label class="text-[11px] text-slate-600">ì‹ ì²­/ì‘ë‹µ</label>
              <input id="csvResp" type="file" accept="text/csv,.csv"
                     class="block w-full text-[12px] cursor-pointer bg-white border border-slate-300 rounded-lg px-2.5 py-1.5 file:mr-2 file:px-2 file:py-1 file:rounded-md file:border-0 file:bg-slate-100 file:text-[11px] file:text-slate-700 file:cursor-pointer" />
              <div id="nameResp" class="fname"></div>
              <label class="inline-flex items-center gap-1.5 text-[11px] mt-0.5 text-slate-600">
                <input type="checkbox" id="headResp" class="accent-blue-600" checked />
                í—¤ë”
              </label>
            </div>
          </div>
        </div>
      </div>

      <div class="rounded-xl border border-slate-200 bg-white px-3 py-3 space-y-3 shadow-sm">
        <div class="space-y-1">
          <div class="flex items-center justify-between text-[12px]">
            <div class="flex items-center gap-1.5">
              <span>ğŸ“„</span>
              <span class="font-semibold text-slate-900">ì‹œíŠ¸ ì„¤ì •</span>
            </div>
          </div>

          <div class="space-y-1.5 mt-1">
            <input id="sheetUrl" type="hidden" />
            <div class="grid grid-cols-3 gap-2 items-end">
              <div class="col-span-2">
                <label class="block text-[11px] text-slate-600 mb-0.5">ì‹œíŠ¸ ê²€ìƒ‰</label>
                <input id="sheetSearch"
                       list="sheetList"
                       type="text"
                       class="w-full bg-white border border-slate-300 rounded-lg px-2.5 py-1.5 text-[12px]"
                       placeholder="ì‹œíŠ¸ ì´ë¦„ ì…ë ¥ í›„ ë“œë¡­ë‹¤ìš´ì—ì„œ ì„ íƒ" />
                <datalist id="sheetList"></datalist>
              </div>
              <div>
                <button id="btnLoadSheets" type="button"
                        class="w-full text-[11px] px-2.5 py-1.5 rounded-full border border-blue-500 bg-white text-blue-600 hover:bg-blue-50">
                  ë¶ˆëŸ¬ì˜¤ê¸°
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="h-px bg-slate-100 my-1"></div>

        <div class="space-y-2">
          <div class="flex flex-wrap items-center gap-3 text-[11px] text-slate-600">
            <label class="inline-flex items-center gap-1.5">
              <input type="checkbox" id="optHasHeader" class="accent-blue-600" checked />
              í—¤ë”
            </label>
            <label class="inline-flex items-center gap-1.5">
              <input type="checkbox" id="optMaskPhone" class="accent-blue-600" />
              ì „í™”ë²ˆí˜¸ ë§ˆìŠ¤í‚¹
            </label>
            <div class="flex items-center gap-1">
              <span class="text-slate-500">ê°’ ì…ë ¥ ë°©ì‹</span>
              <select id="valueInputOption"
                      class="bg-white border border-slate-300 rounded-md px-2 py-1 text-[11px]">
                <option value="USER_ENTERED">USER_ENTERED</option>
                <option value="RAW">RAW</option>
              </select>
            </div>
          </div>

          <div class="flex flex-wrap items-center gap-2">
            <button id="btnPreviewCsv" type="button"
                    class="px-3 py-1.5 rounded-full bg-blue-600 text-white text-[12px] font-medium hover:bg-blue-700 shadow-sm">
              ë¯¸ë¦¬ë³´ê¸°
            </button>
            <button id="btnClear" type="button"
                    class="px-3 py-1.5 rounded-full border border-slate-300 bg-white text-slate-700 text-[12px] hover:bg-slate-50">
              ì´ˆê¸°í™”
            </button>
            <button id="btnSend" type="button"
                    class="px-3 py-1.5 rounded-full bg-red-500 text-white text-[12px] font-semibold hover:bg-red-600 shadow-sm">
              ì‹œíŠ¸ë¡œ ì „ì†¡
            </button>
          </div>
        </div>
      </div>
    </section>

    <section class="rounded-xl border border-slate-200 bg-white px-3 py-3 shadow-sm">
      <div class="flex items-center justify-between mb-2">
        <div class="flex items-center gap-2 text-[12px]">
          <span>ğŸ‘€</span>
          <span class="font-semibold text-slate-900">ì‹œíŠ¸ ë¯¸ë¦¬ë³´ê¸°</span>
        </div>
        <div id="summary" class="text-[11px] text-slate-500"></div>
      </div>
      <div class="scroll-xy" style="max-height: 420px;">
        <table id="previewTable" class="preview"></table>
      </div>
    </section>
  </main>

  <div id="toast" class="toast"></div>

  <script>
  /* =================== ê¸°ë³¸ ì„¤ì • =================== */
  const OAUTH_CLIENT_ID = "18228268359-iifm4ck3j9kqj74eh1p90tco1k2mbpi0.apps.googleusercontent.com";
  const OAUTH_SCOPES   = "https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.readonly";
  const FIXED_SPREADSHEET_ID = "1qclrbo3_VG-sSNIqMW4j1juzwP3nq_ZaT-y1z6WLafc";

  let tokenClient = null;
  let oauthReady  = false;
  let accessToken = null;

  let parsedRows=[];               // í—¤ë”+ë³¸ì²´ (ë‚´ë¶€ 14ì—´ A~N)
  let csvCard=[], csvTickets=[], csvResp=[];
  let allSheetTitles = [];
  let currentSheetName = "";

  const $ = (q)=>document.querySelector(q);
  const toast = (msg, type="info")=>{
    const el=$("#toast"); if(!el) return;
    el.textContent=msg;
    el.classList.add("show");
    if(type==='error') el.style.background='#b91c1c';
    else if(type==='ok') el.style.background='#15803d';
    else el.style.background='#0f172a';
    setTimeout(()=> el.classList.remove("show"), 2600);
  };

  const ensureArrayLen=(len)=>{const a=new Array(len); for(let i=0;i<len;i++) a[i]=''; return a;};
  const equalizeRowLength=(rows)=>{ if(!rows.length) return rows; const m=rows.reduce((p,r)=>Math.max(p,r.length),0); return rows.map(r=>{const c=r.slice(); while(c.length<m) c.push(''); return c;}); };

  const maskPhones=(rows)=>{
    const re1=/(\b\d{3})(\d{4})(\d{4}\b)/g, re2=/(\b\d{2,3}-)(\d{3,4})(-\d{4}\b)/g;
    return rows.map(row=> row.map(cell=>{
      if(typeof cell!=='string') return cell;
      let out=cell.replace(re1,(m,a,b,c)=>`${a}****${c}`);
      out=out.replace(re2,(m,a,b,c)=>`${a}****${c}`);
      return out;
    }));
  };

  const normName=(s)=> String(s||'').trim()
    .replace(/[\s]*[\(\[\{ï¼ˆã€][^)\]\}ï¼‰ã€‘]*[\)\]\}ï¼‰ã€‘]\s*$/,'')
    .replace(/[/_\-\s]+$/,'')
    .replace(/\s+/g,' ')
    .trim();

  function parseMoney(v){
    const s=String(v??'').replace(/[^\d\-\.\,()]/g,'');
    if(!s) return 0;
    let neg=false, t=s;
    if(/\(/.test(t) && /\)/.test(t)) { neg=true; t=t.replace(/[()]/g,''); }
    t=t.replace(/,/g,'');
    if(/^-/.test(t)) neg=!neg;
    const n=parseFloat(t);
    return (neg?-1:1) * (isNaN(n)?0:n);
  }

  function findColIndex(head, names){
    const H=(head||[]).map(x=>String(x||'').toLowerCase().trim());
    for(let i=0;i<H.length;i++){
      for(const nm of names){ if(H[i].includes(String(nm).toLowerCase())) return i; }
    }
    return -1;
  }

  /* =================== ë‚ ì§œ íŒŒì‹± =================== */
  function getTimeFromAny(val){
    if(val===undefined || val===null) return NaN;
    const s0=String(val).trim(); if(!s0) return NaN;
    const pm=/ì˜¤í›„/.test(s0), am=/ì˜¤ì „/.test(s0);
    const m=s0.match(/(\d{4})\D(\d{1,2})\D(\d{1,2})(?:\D+(\d{1,2})(?::(\d{1,2})(?::(\d{1,2}))?)?)?/);
    if(m){
      let [,yy,MM,dd,hh,mm,ss]=m;
      let H=hh?parseInt(hh,10):0, Mi=mm?parseInt(mm,10):0, S=ss?parseInt(ss,10):0;
      if(pm && H<12) H+=12; if(am && H===12) H=0;
      return new Date(+yy, +MM-1, +dd, H, Mi, S).getTime();
    }
    const iso=s0.replace(/[./]/g,'-').replace('T',' '); const t=Date.parse(iso);
    return isNaN(t)?NaN:t;
  }

  /* =================== Google API =================== */
  async function ensureGapiLoaded(){
    await new Promise(res=>{
      const chk=()=>{if(window.gapi && gapi.load){res();} else setTimeout(chk,50);};
      chk();
    });
    await new Promise((res,rej)=>{
      gapi.load('client', async ()=>{
        try{
          await gapi.client.load('https://sheets.googleapis.com/$discovery/rest?version=v4');
          res();
        }catch(e){ rej(e); }
      });
    });
  }

  function loadTokenFromSession(){
    const saved = sessionStorage.getItem("ca_gapi_token");
    if(saved){
      accessToken = saved;
      oauthReady  = true;
    }
  }

  function initGoogleAuth(){
    if(!window.google?.accounts?.oauth2){
      toast('Google ë¡œê·¸ì¸ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.','error');
      return;
    }
    if(!tokenClient){
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: OAUTH_CLIENT_ID,
        scope: OAUTH_SCOPES,
        callback: (resp)=>{
          if(resp?.access_token){
            accessToken = resp.access_token;
            sessionStorage.setItem("ca_gapi_token", accessToken);
            if(window.gapi?.client){
              gapi.client.setToken({access_token:accessToken});
            }
            oauthReady = true;
            updateAuthUI();
            toast('Google ì¸ì¦ ì™„ë£Œ','ok');
          }else{
            toast('ì¸ì¦ ì‹¤íŒ¨','error');
          }
        }
      });
    }
    tokenClient.requestAccessToken({prompt:'consent'});
  }

  async function ensureAuth(){
    await ensureGapiLoaded();
    if(accessToken){
      gapi.client.setToken({access_token:accessToken});
      return;
    }
    const saved = sessionStorage.getItem("ca_gapi_token");
    if(saved){
      accessToken = saved;
      gapi.client.setToken({access_token:accessToken});
      oauthReady = true;
      updateAuthUI();
      return;
    }
    throw new Error('âš  Google ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤. ìƒë‹¨ì˜ [Google ì¸ì¦] ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.');
  }

  function parseSpreadsheetId(){ return FIXED_SPREADSHEET_ID; }

  async function listSheets(spreadsheetId){
    const res = await gapi.client.sheets.spreadsheets.get({ spreadsheetId, fields: "sheets(properties(title))" });
    return (res.result?.sheets||[]).map(x=> x.properties?.title).filter(Boolean);
  }

  /* =================== CSV ë¡œë“œ =================== */
  function readCsv(file){
    return new Promise((resolve)=>{
      if(!file){ resolve([]); return; }
      Papa.parse(file,{
        complete:(res)=>{
          let rows=Array.isArray(res.data)?res.data:[];
          rows=rows.map(r=> Array.isArray(r)?r:[r]);
          const cnt=rows.filter(r=> r.some(c=> String(c).trim()!=='')).length;
          if(cnt>0){ resolve(rows); return; }
          const tryEnc=['UTF-8','EUC-KR','CP949','ISO-8859-1']; let idx=0;
          const fr=new FileReader();
          fr.onload=()=>{
            const parsed=Papa.parse(String(fr.result||''),{skipEmptyLines:'greedy'});
            let r=Array.isArray(parsed.data)?parsed.data:[]; r=r.map(x=>Array.isArray(x)?x:[x]);
            const c=r.filter(x=>x.some(y=>String(y).trim()!=='' )).length;
            if(c>0 || idx>=tryEnc.length-1) resolve(r);
            else { idx++; fr.readAsText(file, tryEnc[idx]); }
          };
          fr.onerror=()=>resolve([]);
          fr.readAsText(file, tryEnc[idx]);
        },
        error:()=>{
          const fr=new FileReader();
          fr.onload=()=>{
            const parsed=Papa.parse(String(fr.result||''),{skipEmptyLines:'greedy'});
            let r=Array.isArray(parsed.data)?parsed.data:[]; r=r.map(x=>Array.isArray(x)?x:[x]);
            resolve(r);
          };
          fr.onerror=()=>resolve([]);
          fr.readAsText(file,'UTF-8');
        },
        skipEmptyLines:'greedy'
      });
    });
  }

  /* =================== ì‹œíŠ¸ í—¤ë” & ê³µí†µ =================== */
  function buildHeader(){
    return ['A','B','C','D','E','F','G','H(ê²°ì œê¸ˆì•¡)','I(ìƒíƒœ)','J','K(ê²°ì œì‹œê°„)','L(ê²°ì œìˆ˜ë‹¨)','M(í™˜ë¶ˆê¸ˆì•¡)','N(í™˜ë¶ˆì¼ì‹œ)'];
  }

  function processCardRows(rows, skipHeader=true){
    const out=[]; const start=skipHeader?1:0;
    for(let i=start;i<rows.length;i++){
      const r=rows[i]||[];
      if(r.length===0 || r.every(x=>String(x).trim()==='')) continue;
      const o=ensureArrayLen(14);
      for(let j=0;j<10;j++){ o[1+j]=r[j]??''; }
      o[11]='ì‹ ìš©ì¹´ë“œ';
      o[12]= r[10] ?? o[12];
      o[13]= r[11] ?? o[13];
      out.push(o);
    }
    out.sort((a,b)=> (getTimeFromAny(a[10])||Infinity) - (getTimeFromAny(b[10])||Infinity));
    return out;
  }

  function makeBankRows(tickets, responses, skipT = true, skipR = true) {
    if (!tickets.length) return [];

    const IDX_DATE   = 0;
    const IDX_TIME   = 1;
    const IDX_REFUND = 5;
    const IDX_SALE   = 6;
    const IDX_REASON = 10;
    const IDX_GROUP  = 21;

    const tHead = tickets[0] || [];

    const rHead = responses[0] || [];
    const rName  = findColIndex(rHead, ['ì„±í•¨','ì´ë¦„','ì‹ ì²­ì','name']);
    const rEmail = findColIndex(rHead, ['ì´ë©”ì¼','email']);
    const rPhone = findColIndex(rHead, ['ì—°ë½ì²˜','ì „í™”','íœ´ëŒ€í°','phone','mobile']);

    const respMap = new Map();
    const rStart  = skipR ? 1 : 0;

    if (rName >= 0) {
      for (let i = rStart; i < responses.length; i++) {
        const rr = responses[i] || [];
        const nm = normName(rr[rName] || '');
        if (!nm) continue;
        if (!respMap.has(nm)) {
          respMap.set(nm, {
            email: rEmail >= 0 ? (rr[rEmail] || '') : '',
            phone: rPhone >= 0 ? (rr[rPhone] || '') : ''
          });
        }
      }
    }

    const cName  = findColIndex(tHead, ['ë³´ë‚¸ë¶„/ë°›ëŠ”ë¶„','ê±°ë˜ìƒëŒ€ëª…','ê±°ë˜ì²˜','ì„±ëª…','ìƒëŒ€']);
    const cPlace = findColIndex(tHead, ['ì‚¬ìš©ì²˜','ì ìš”','ë‚´ìš©','ë©”ëª¨']);
    const cNote  = findColIndex(tHead, ['ê³„ì¢Œì ìš”']);

    function pickCounterpartyName(row) {
      let s = '';
      if (cNote  >= 0) s = row[cNote]  || '';
      if (!s && cName  >= 0) s = row[cName]  || '';
      if (!s && cPlace >= 0) s = row[cPlace] || '';
      s = String(s || '').trim();
      if (!s) return '';
      if (s.includes('â†')) s = s.split('â†')[0];
      if (s.includes('â†’')) s = s.split('â†’')[0];
      return normName(s);
    }

    const groups = new Map();
    const tStart = skipT ? 1 : 0;

    for (let i = tStart; i < tickets.length; i++) {
      const r = tickets[i] || [];
      if (r.every(x => String(x).trim() === '')) continue;
      if (r.length <= Math.max(IDX_GROUP, IDX_SALE, IDX_REFUND)) continue;

      const groupKey = String(r[IDX_GROUP] ?? '').trim();
      if (!groupKey) continue;

      const dateStr = String(r[IDX_DATE] ?? '').trim();
      const timeStr = String(r[IDX_TIME] ?? '').trim();
      const when = (dateStr || timeStr) ? `${dateStr} ${timeStr}`.trim() : '';

      const saleRaw   = parseMoney(r[IDX_SALE]);
      const refundRaw = parseMoney(r[IDX_REFUND]);
      if (!saleRaw && !refundRaw) continue;

      const nameN = pickCounterpartyName(r);

      let g = groups.get(groupKey);
      if (!g) {
        g = { sales: [], refunds: [], reason: '' };
        groups.set(groupKey, g);
      }

      const reasonCell = String(r[IDX_REASON] ?? '').trim();
      if (reasonCell && !g.reason) g.reason = reasonCell;

      if (saleRaw) g.sales.push({ when, amt: Math.abs(saleRaw), name: nameN });
      if (refundRaw) g.refunds.push({ when, amt: -Math.abs(refundRaw) });
    }

    const out = [];

    for (const [groupKey, g] of groups.entries()) {
      if (!g.sales.length) continue;

      const saleSum   = g.sales.reduce((s, x) => s + (x.amt || 0), 0);
      const refundSum = g.refunds.reduce((s, x) => s + (x.amt || 0), 0);
      const net       = saleSum + refundSum;
      const refundAmount = -refundSum || 0;

      let refundDate = '';
      if (g.refunds.length) {
        g.refunds.sort((a, b) => (getTimeFromAny(a.when) || 0) - (getTimeFromAny(b.when) || 0));
        refundDate = g.refunds[g.refunds.length - 1].when || '';
      }

      g.sales.sort((a, b) => (getTimeFromAny(a.when) || 0) - (getTimeFromAny(b.when) || 0));
      const firstSale = g.sales[0];
      const nameN     = firstSale.name || '';
      const meta      = respMap.get(nameN) || { email: '', phone: '' };

      let status = 'ê²°ì œì™„ë£Œ';
      if (refundAmount > 0) status = (net === 0) ? 'í™˜ë¶ˆë¨' : 'ë¶€ë¶„í™˜ë¶ˆ';

      const row = ensureArrayLen(14);
      row[1]  = g.reason || '';
      row[2]  = g.reason || '';
      row[3]  = nameN;
      row[4]  = meta.phone;
      row[5]  = meta.email;
      row[6]  = 'ê°•ì˜';
      row[7]  = saleSum;
      row[8]  = status;
      row[9]  = 'ë©´ì„¸';
      row[10] = firstSale.when;
      row[11] = 'ê³„ì¢Œì´ì²´';
      row[12] = refundAmount || '';
      row[13] = refundDate;
      out.push(row);
    }

    out.sort((a, b) => (getTimeFromAny(a[10]) || Infinity) - (getTimeFromAny(b[10]) || Infinity));
    return out;
  }

  function buildFinalRows(){
    const header=buildHeader();
    const card = csvCard.length ? processCardRows(csvCard, $('#headCard').checked) : [];
    const bank = csvTickets.length ? makeBankRows(csvTickets, csvResp, $('#headTicket').checked, $('#headResp').checked) : [];
    parsedRows=[header, ...card, ...bank];
    $('#optHasHeader').checked=true;
  }

  function renderPreview(rows){
    const table=$('#previewTable'); table.innerHTML='';
    if(!rows.length){ $('#summary').textContent='í–‰ 0'; return; }

    const thead=document.createElement('thead');
    const tbody=document.createElement('tbody');
    const colCount=rows[0].length;

    if($('#optHasHeader').checked){
      const tr=document.createElement('tr');
      rows[0].forEach((h,idx)=>{
        const th=document.createElement('th');
        th.textContent=h||`(col${idx+1})`;
        tr.appendChild(th);
      });
      thead.appendChild(tr);
    }
    const startIdx=$('#optHasHeader').checked?1:0;
    for(let r=startIdx;r<rows.length;r++){
      const tr=document.createElement('tr'), row=rows[r];
      for(let c=0;c<colCount;c++){
        const td=document.createElement('td');
        const v=(row[c]??'').toString();
        if(row.length!==colCount) td.classList.add('invalid');
        td.textContent=v;
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
    }
    table.appendChild(thead);
    table.appendChild(tbody);
    const bodyRows=Math.max(0, rows.length-(startIdx));
    $('#summary').textContent=`ì—´ ${colCount} Â· ë°ì´í„° í–‰ ${bodyRows}`;
  }

  /* =================== UPSERT =================== */
  function normPhone(s){ return String(s||'').replace(/\D/g,''); }
  function normMethod(s){
    const v = String(s||'').trim();
    if(!v) return '';
    if(/ì¹´ë“œ|credit|card/i.test(v)) return 'ì‹ ìš©ì¹´ë“œ';
    if(/ê³„ì¢Œ|ì´ì²´|bank|transfer/i.test(v)) return 'ê³„ì¢Œì´ì²´';
    return v;
  }

  // ê¸°ë³¸í‚¤: D/E/L
  function makeDELKey(name, phone, method){
    const n = normName(name);
    const p = normPhone(phone);
    const m = normMethod(method);
    if(!n && !p) return '';
    return `${n}|${p}|${m}`;
  }

  // ë³´ì¡°í‚¤: D/E (ê²°ì œìˆ˜ë‹¨ ì•ˆ ì„ê¸° ìœ„í•´ methodë³„ë¡œ ë‹¤ì‹œ í•„í„°)
  function makeDEKey(name, phone){
    const n = normName(name);
    const p = normPhone(phone);
    if(!n && !p) return '';
    return `${n}|${p}`;
  }

  // BN ì¸ë±ìŠ¤(B..N): D=2, E=3, I=7, K=9, L=10, M=11, N=12
  function getEventTimeBN(bn){
    const tPay = getTimeFromAny(bn?.[9]);
    const tRef = getTimeFromAny(bn?.[12]);
    const a = isNaN(tPay) ? -Infinity : tPay;
    const b = isNaN(tRef) ? -Infinity : tRef;
    return Math.max(a, b);
  }

  function statusRankBN(bn){
    const s = String(bn?.[7] ?? '').trim();
    if(s.includes('ê²°ì œì™„ë£Œ')) return 3;
    if(s.includes('ë¶€ë¶„í™˜ë¶ˆ')) return 2;
    if(s.includes('í™˜ë¶ˆ')) return 1;
    return 0;
  }

  // entry: { bn, seq }
  function chooseBetterEntry(prev, cur){
    if(!prev) return cur;
    if(!cur) return prev;

    const ep = getEventTimeBN(prev.bn);
    const ec = getEventTimeBN(cur.bn);

    if(ep !== ec) return (ec > ep) ? cur : prev;

    const rp = statusRankBN(prev.bn);
    const rc = statusRankBN(cur.bn);
    if(rp !== rc) return (rc > rp) ? cur : prev;

    return (cur.seq > prev.seq) ? cur : prev;
  }

  function sameRowBN(a,b){
    const A = (a||[]), B=(b||[]);
    const len = 13;
    for(let i=0;i<len;i++){
      const x = String(A[i] ?? '');
      const y = String(B[i] ?? '');
      if(x !== y) return false;
    }
    return true;
  }

  async function fetchExistingBN(spreadsheetId, sheetName){
    const res = await gapi.client.sheets.spreadsheets.values.get({
      spreadsheetId,
      range: `${sheetName}!B2:N`,
      majorDimension: 'ROWS'
    });
    return res.result?.values || [];
  }

  async function getLastNumberRowFromA(spreadsheetId, sheetName){
    const res = await gapi.client.sheets.spreadsheets.values.get({
      spreadsheetId,
      range: `${sheetName}!A2:A`,
      majorDimension: 'ROWS'
    });
    const vals = res.result?.values || [];
    return 1 + vals.length;
  }

  // âœ… ê¸°ì¡´ ì¸ë±ìŠ¤:
  // - mapDEL: DEL ëŒ€í‘œ(ì¤‘ë³µì´ë©´ "ìµœì‹ " ëŒ€í‘œí–‰)
  // - mapDEMethod: DE -> (method -> ëŒ€í‘œí–‰)  â† DEL ë¯¸ìŠ¤ë§¤ì¹˜ ë³´í—˜
  function buildExistingIndexes(existingBN){
    const mapDEL = new Map(); // delKey -> { rowNumber, bn, seq }
    const mapDEMethod = new Map(); // deKey -> Map(methodNorm -> { rowNumber, bn, seq })

    for(let i=0;i<existingBN.length;i++){
      const bn = existingBN[i] || [];
      const rowNumber = 2 + i;

      const name = bn?.[2] ?? '';   // D
      const phone = bn?.[3] ?? '';  // E
      const method = bn?.[10] ?? ''; // L

      const delKey = makeDELKey(name, phone, method);
      const deKey  = makeDEKey(name, phone);
      const mNorm  = normMethod(method);

      // 1) DEL ëŒ€í‘œ
      if(delKey){
        const cur = { rowNumber, bn, seq: rowNumber };
        const prev = mapDEL.get(delKey);
        if(!prev){
          mapDEL.set(delKey, cur);
        }else{
          const better = chooseBetterEntry({bn: prev.bn, seq: prev.seq}, {bn: cur.bn, seq: cur.seq});
          if(better.seq === cur.seq) mapDEL.set(delKey, cur);
        }
      }

      // 2) DE + method ëŒ€í‘œ (ë³´í—˜)
      if(deKey && mNorm){
        let byMethod = mapDEMethod.get(deKey);
        if(!byMethod){
          byMethod = new Map();
          mapDEMethod.set(deKey, byMethod);
        }
        const cur = { rowNumber, bn, seq: rowNumber };
        const prev = byMethod.get(mNorm);
        if(!prev){
          byMethod.set(mNorm, cur);
        }else{
          const better = chooseBetterEntry({bn: prev.bn, seq: prev.seq}, {bn: cur.bn, seq: cur.seq});
          if(better.seq === cur.seq) byMethod.set(mNorm, cur);
        }
      }
    }

    return { mapDEL, mapDEMethod };
  }

  async function batchUpdateRows(spreadsheetId, valueInputOption, updates){
    if(!updates.length) return 0;
    const res = await gapi.client.sheets.spreadsheets.values.batchUpdate({
      spreadsheetId,
      resource: {
        valueInputOption,
        data: updates
      }
    });
    return res.result?.totalUpdatedRows ?? updates.length;
  }

  // ì‹ ê·œëŠ” "ë²ˆí˜¸(A) ì•ˆ ë°€ë¦¬ê²Œ" ë¹ˆ ìŠ¬ë¡¯ë¶€í„° ì±„ìš°ê³  ì´ˆê³¼ëŠ” append
  async function writeNewRowsIntoEmptySlots(spreadsheetId, sheetName, valueInputOption, existingBN, rowsBN){
    if(!rowsBN.length) return { filled:0, appended:0 };

    const lastNumberRow = await getLastNumberRowFromA(spreadsheetId, sheetName);
    const maxSlots = Math.max(0, lastNumberRow - 1);

    // ë¹ˆìŠ¬ë¡¯ íŒë‹¨ë„ A ë¬´ì‹œ, D/E/Lë§Œ
    let startSlot = maxSlots;
    for(let i=0;i<maxSlots;i++){
      const bn = existingBN[i] || [];
      const name = bn?.[2] ?? '';
      const phone = bn?.[3] ?? '';
      const method = bn?.[10] ?? '';
      const delKey = makeDELKey(name, phone, method);
      if(!delKey){
        startSlot = i;
        break;
      }
    }

    let startRow = 2 + startSlot;
    const availableCount = Math.max(0, lastNumberRow - startRow + 1);

    const toFill = rowsBN.slice(0, availableCount);
    const overflow = rowsBN.slice(availableCount);

    let filled = 0;
    let appended = 0;

    if(toFill.length){
      const endRow = startRow + toFill.length - 1;
      await gapi.client.sheets.spreadsheets.values.update({
        spreadsheetId,
        range: `${sheetName}!B${startRow}:N${endRow}`,
        valueInputOption,
        resource: { majorDimension:'ROWS', values: toFill }
      });
      filled = toFill.length;
    }

    if(overflow.length){
      const res = await gapi.client.sheets.spreadsheets.values.append({
        spreadsheetId,
        range: `${sheetName}!B2:N`,
        valueInputOption,
        insertDataOption: 'INSERT_ROWS',
        resource: { majorDimension:'ROWS', values: overflow }
      });
      const updated = res.result?.updates?.updatedRows;
      appended = (typeof updated === 'number') ? updated : overflow.length;
    }

    return { filled, appended };
  }

  /* =================== ì´ë²¤íŠ¸ =================== */
  window.addEventListener('error', e=> toast('ì˜¤ë¥˜: '+(e?.error?.message||e.message||'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'),'error'));
  window.addEventListener('unhandledrejection', e=> toast('ì²˜ë¦¬ë˜ì§€ ì•Šì€ ì˜¤ë¥˜: '+(e?.reason?.message||e.reason||'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'),'error'));

  document.addEventListener('DOMContentLoaded', ()=>{
    loadTokenFromSession();

    const sheetInput = $('#sheetUrl');
    if(sheetInput) sheetInput.value = FIXED_SPREADSHEET_ID;

    $('#csvCard').addEventListener('change', async (e)=>{
      try{
        const f=e.target.files?.[0];
        if(!f){ toast('ì¹´ë“œ CSV ì„ íƒì´ ë¹„ì—ˆìŠµë‹ˆë‹¤','error'); return; }
        csvCard=await readCsv(f);
        const cnt=csvCard.filter(r=>Array.isArray(r)&&r.some(c=>String(c).trim()!=='')).length;
        toast(`ì¹´ë“œ CSV ë¡œë“œ: ${csvCard.length}í–‰ (ìœ íš¨ ${cnt}í–‰)`, cnt?'ok':'error');
      }catch(err){ console.error(err); toast('ì¹´ë“œ CSV ì½ê¸° ì‹¤íŒ¨','error'); }
    }, {capture:true});

    $('#csvTicket').addEventListener('change', async (e)=>{
      try{
        const f=e.target.files?.[0];
        if(!f){ toast('tickets CSV ì„ íƒì´ ë¹„ì—ˆìŠµë‹ˆë‹¤','error'); return; }
        csvTickets=await readCsv(f);
        const cnt=csvTickets.filter(r=>Array.isArray(r)&&r.some(c=>String(c).trim()!=='')).length;
        toast(`tickets ë¡œë“œ: ${csvTickets.length}í–‰ (ìœ íš¨ ${cnt}í–‰)`, cnt?'ok':'error');
      }catch(err){ console.error(err); toast('tickets ì½ê¸° ì‹¤íŒ¨','error'); }
    }, {capture:true});

    $('#csvResp').addEventListener('change', async (e)=>{
      try{
        const f=e.target.files?.[0];
        if(!f){ toast('responses CSV ì„ íƒì´ ë¹„ì—ˆìŠµë‹ˆë‹¤','error'); return; }
        csvResp=await readCsv(f);
        const cnt=csvResp.filter(r=>Array.isArray(r)&&r.some(c=>String(c).trim()!=='')).length;
        toast(`responses ë¡œë“œ: ${csvResp.length}í–‰ (ìœ íš¨ ${cnt}í–‰)`, cnt?'ok':'error');
      }catch(err){ console.error(err); toast('responses ì½ê¸° ì‹¤íŒ¨','error'); }
    }, {capture:true});

    $('#btnPreviewCsv').addEventListener('click', (e)=>{
      e.preventDefault();
      try{
        if(!csvCard.length && !csvTickets.length){
          parsedRows=[buildHeader()];
          renderPreview(parsedRows);
          toast('CSVë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš” (í—¤ë”ë§Œ í‘œì‹œ)','error');
          return;
        }
        buildFinalRows();
        let rows=parsedRows;
        if($('#optMaskPhone').checked) rows=maskPhones(rows);
        rows=equalizeRowLength(rows);
        renderPreview(rows);
        toast('ë¯¸ë¦¬ë³´ê¸° ê°±ì‹ ','ok');
      }catch(err){ console.error(err); toast('ì •ë¦¬ ì‹¤íŒ¨: ì½˜ì†” í™•ì¸','error'); }
    });

    $('#btnClear').addEventListener('click', (e)=>{
      e.preventDefault();
      csvCard=[]; csvTickets=[]; csvResp=[]; parsedRows=[];
      $('#csvCard').value=''; $('#csvTicket').value=''; $('#csvResp').value='';
      $('#previewTable').innerHTML=''; $('#summary').textContent='';
      toast('ì´ˆê¸°í™” ì™„ë£Œ');
    });

    $('#btnLoadSheets').addEventListener('click', async (e)=>{
      e.preventDefault();
      try{
        toast('ì‹œíŠ¸ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...');
        await ensureAuth();
        const spreadsheetId = parseSpreadsheetId();
        const titles = await listSheets(spreadsheetId);

        allSheetTitles = titles || [];

        const dl = $('#sheetList');
        dl.innerHTML = '';
        allSheetTitles.forEach(t=>{
          const opt = document.createElement('option');
          opt.value = t;
          dl.appendChild(opt);
        });

        currentSheetName = allSheetTitles[0] || '';
        const searchInput = $('#sheetSearch');
        if (currentSheetName && searchInput) searchInput.value = currentSheetName;

        toast(`ì‹œíŠ¸ ${allSheetTitles.length}ê°œ ë¶ˆëŸ¬ì˜´`,'ok');
      }catch(err){
        console.error(err);
        toast(err?.message || 'ì‹œíŠ¸ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨','error');
      }
    });

    const searchInput = $('#sheetSearch');
    if (searchInput) {
      searchInput.addEventListener('change', (e)=>{
        const val = (e.target.value || '').trim();
        if (!val) return;
        if (!allSheetTitles.includes(val)) {
          toast('í•´ë‹¹ ì´ë¦„ì˜ ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë“œë¡­ë‹¤ìš´ì—ì„œ ì„ íƒí•´ì£¼ì„¸ìš”.','error');
          currentSheetName = '';
          return;
        }
        currentSheetName = val;
        toast(`ì„ íƒëœ ì‹œíŠ¸: ${currentSheetName}`,'ok');
      });
    }

    // âœ… ì „ì†¡: DEL ê°™ìœ¼ë©´ ë¬´ì¡°ê±´ update (ì‹ ìš©ì¹´ë“œê°€ ìƒˆë¡œ ì­‰ append ë˜ëŠ” ë¬¸ì œ ë°©ì§€)
    $('#btnSend').addEventListener('click', async (e)=>{
      e.preventDefault();
      try{
        await ensureAuth();

        if(!parsedRows.length){
          toast('ë¨¼ì € ì •ë¦¬ ë¯¸ë¦¬ë³´ê¸°ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”','error');
          return;
        }

        const spreadsheetId = parseSpreadsheetId();
        const sheetName = (currentSheetName || allSheetTitles[0] || 'Sheet1');
        if(!sheetName){
          toast('ì‹œíŠ¸ë¥¼ ë¨¼ì € ë¶ˆëŸ¬ì˜¤ê³  ì„ íƒí•´ì£¼ì„¸ìš”.','error');
          return;
        }

        const hasHeader = $('#optHasHeader').checked;
        const rowsAll   = hasHeader ? parsedRows.slice(1) : parsedRows;
        if(!rowsAll.length){
          toast('ì „ì†¡í•  ë°ì´í„° í–‰ì´ ì—†ìŠµë‹ˆë‹¤','error');
          return;
        }

        const valueInputOption = $('#valueInputOption').value;

        // 1) incoming: DEL í‚¤ë¡œë§Œ ë³‘í•© (ì¤‘ë³µì´ë©´ ìµœì‹  ì´ë²¤íŠ¸/ìƒíƒœ/íŒŒì¼ìˆœ)
        const incoming = new Map(); // delKey -> {bn, seq, deKey, methodNorm}
        let seq = 0;
        for(const r of rowsAll){
          seq++;
          const row = Array.isArray(r) ? r : [];

          // ë‚´ë¶€ index: D=3, E=4, L=11
          const name   = row?.[3] ?? '';
          const phone  = row?.[4] ?? '';
          const method = row?.[11] ?? '';

          const delKey = makeDELKey(name, phone, method);
          if(!delKey) continue;

          const bn = row.slice(1, 14); // B~N(13)
          while(bn.length < 13) bn.push('');

          const deKey = makeDEKey(name, phone);
          const mNorm = normMethod(method);

          const cur = { bn, seq, deKey, methodNorm: mNorm };
          const prev = incoming.get(delKey);
          incoming.set(delKey, chooseBetterEntry(prev, cur));
        }

        const keys = Array.from(incoming.keys());
        if(!keys.length){
          toast('ìœ íš¨í•œ (D/E/L) ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤','error');
          return;
        }

        toast('ê¸°ì¡´ ì‹œíŠ¸ì™€ ë¹„êµ ì¤‘...');

        // 2) existing ì¸ë±ìŠ¤(DEL + ë³´í—˜(DE+method))
        const existingBN = await fetchExistingBN(spreadsheetId, sheetName);
        const { mapDEL, mapDEMethod } = buildExistingIndexes(existingBN);

        // 3) update vs new
        const updates = [];
        const toAppend = [];

        for(const delKey of keys){
          const entry = incoming.get(delKey);
          const bn = entry.bn;

          let hit = mapDEL.get(delKey);

          // âœ… ë³´í—˜: DELì´ ë¯¸ì„¸í•˜ê²Œ ì•ˆ ë§ì•„ë„, DE ê°™ê³  methodNorm ê°™ìœ¼ë©´ ê·¸ í–‰ ì—…ë°ì´íŠ¸ë¡œ ì²˜ë¦¬
          if(!hit && entry.deKey && entry.methodNorm){
            const byMethod = mapDEMethod.get(entry.deKey);
            if(byMethod){
              const cand = byMethod.get(entry.methodNorm);
              if(cand) hit = cand;
            }
          }

          if(hit){
            if(!sameRowBN(hit.bn, bn)){
              updates.push({
                range: `${sheetName}!B${hit.rowNumber}:N${hit.rowNumber}`,
                values: [bn]
              });
            }
          }else{
            // ì§„ì§œë¡œ ë™ì¼ DE+methodê°€ ì—†ì„ ë•Œë§Œ ì‹ ê·œ append
            toAppend.push(bn);
          }
        }

        if(!updates.length && !toAppend.length){
          toast('ë³€ê²½/ì¶”ê°€í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤','ok');
          return;
        }

        $('#btnSend').disabled = true;

        let updatedCnt = 0, addedCnt = 0;

        if(updates.length){
          toast(`ê¸°ì¡´ ${updates.length}í–‰ ì—…ë°ì´íŠ¸ ì¤‘...`);
          updatedCnt = await batchUpdateRows(spreadsheetId, valueInputOption, updates);
        }

        if(toAppend.length){
          toast(`ì‹ ê·œ ${toAppend.length}í–‰ ì¶”ê°€ ì¤‘...(Aì—´ ë¬´ì‹œ/ë²ˆí˜¸ ìœ ì§€)`);
          const r = await writeNewRowsIntoEmptySlots(
            spreadsheetId,
            sheetName,
            valueInputOption,
            existingBN,
            toAppend
          );
          addedCnt = (r.filled || 0) + (r.appended || 0);
        }

        toast(`ì™„ë£Œ: ì—…ë°ì´íŠ¸ ${updatedCnt}í–‰ / ì‹ ê·œì¶”ê°€ ${addedCnt}í–‰`, 'ok');

      }catch(err){
        console.error(err);
        toast(err?.message || 'ì „ì†¡ ì‹¤íŒ¨: ì½˜ì†” í™•ì¸','error');
      }finally{
        $('#btnSend').disabled=false;
      }
    });

    $('#btnAuthRefresh').addEventListener('click', (e)=>{
      e.preventDefault();
      initGoogleAuth();
    });

    window.updateAuthUI = ()=>{
      const dot = $('#authStateDot');
      const label = $('#authState');
      if(!dot || !label) return;
      if(accessToken){
        dot.style.background = '#22c55e';
        label.textContent = 'Google ì‹œíŠ¸ ì—°ë™ ì™„ë£Œ';
      }else{
        dot.style.background = '#cbd5f5';
        label.textContent = 'Google ì‹œíŠ¸ ì—°ë™ ì¤€ë¹„ ì¤‘';
      }
    };

    updateAuthUI();
  });
  </script>
</body>
</html>
